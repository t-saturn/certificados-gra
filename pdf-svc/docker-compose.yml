# =============================================================================
# docker-compose.yml - Local development environment
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # PDF Service
  # ---------------------------------------------------------------------------
  pdf-svc:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pdf-svc
    restart: unless-stopped
    environment:
      # Redis configuration
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - REDIS_PASSWORD=
      - REDIS_JOB_TTL_SECONDS=3600
      - REDIS_KEY_PREFIX=pdf-svc
      # Queue names
      - REDIS_QUEUE_PDF_DOWNLOAD=pdf:queue:download
      - REDIS_QUEUE_PDF_RENDER=pdf:queue:render
      - REDIS_QUEUE_PDF_QR=pdf:queue:qr
      - REDIS_QUEUE_PDF_INSERT=pdf:queue:insert
      - REDIS_QUEUE_PDF_UPLOAD=pdf:queue:upload
      # NATS configuration
      - NATS_URL=nats://nats:4222
      # File service subjects
      - FILE_SVC_DOWNLOAD_SUBJECT=files.download.requested
      - FILE_SVC_UPLOAD_SUBJECT=files.upload.requested
      - FILE_SVC_DOWNLOAD_COMPLETED_SUBJECT=files.download.completed
      - FILE_SVC_UPLOAD_COMPLETED_SUBJECT=files.upload.completed
      # PDF service subjects
      - PDF_SVC_PROCESS_SUBJECT=pdf.process.requested
      - PDF_SVC_COMPLETED_SUBJECT=pdf.process.completed
      - PDF_SVC_FAILED_SUBJECT=pdf.process.failed
      # Logging
      - LOG_DIR=/app/logs
      - LOG_LEVEL=DEBUG
      - LOG_FORMAT=json
      # QR settings
      - QR_LOGO_URL=
      - QR_LOGO_PATH=/app/assets/logo.png
      - QR_LOGO_CACHE_PATH=/app/assets/cached_logo.png
      # General
      - ENVIRONMENT=development
      - TEMP_DIR=/app/tmp
    volumes:
      - ./logs:/app/logs
      - ./assets:/app/assets
      - pdf-tmp:/app/tmp
    depends_on:
      redis:
        condition: service_healthy
      nats:
        condition: service_started
    networks:
      - pdf-network
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---------------------------------------------------------------------------
  # Redis - Job persistence and queues
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: pdf-svc-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - pdf-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "6379:6379"  # Remove in production

  # ---------------------------------------------------------------------------
  # NATS - Event messaging
  # ---------------------------------------------------------------------------
  nats:
    image: nats:2-alpine
    container_name: pdf-svc-nats
    restart: unless-stopped
    command: 
      - "--jetstream"
      - "--store_dir=/data"
      - "--http_port=8222"
    volumes:
      - nats-data:/data
    networks:
      - pdf-network
    ports:
      - "4222:4222"   # Client connections
      - "8222:8222"   # HTTP monitoring (remove in production)

  # ---------------------------------------------------------------------------
  # NATS Box - CLI tools for debugging
  # ---------------------------------------------------------------------------
  nats-box:
    image: natsio/nats-box:latest
    container_name: pdf-svc-nats-box
    stdin_open: true
    tty: true
    networks:
      - pdf-network
    depends_on:
      - nats
    profiles:
      - debug

# =============================================================================
# Volumes
# =============================================================================
volumes:
  redis-data:
    driver: local
  nats-data:
    driver: local
  pdf-tmp:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  pdf-network:
    driver: bridge
